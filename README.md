# Transaction Consumer API

Web API для создания и получения транзакций согласно техническому заданию.

## Функциональность

### POST /api/v1/Transaction
Создает новую транзакцию. Метод идемпотентный - при повторной отправке запроса с тем же Id возвращает результат предыдущего запроса.

**Запрос:**
```json
{
    "id": "1afa615f-af61-4d8a-b891-bc874c937772",
    "transactionDate": "2024-10-25T00:00:00+05:00",
    "amount": 12.34
}
```

**Ответ:**
```json
{
    "insertDateTime": "2024-10-25T12:03:34+05:00"
}
```

### GET /api/v1/Transaction?id={guid}
Получает транзакцию по Id.

**Ответ:**
```json
{
    "id": "1afa615f-af61-4d8a-b891-bc874c937772",
    "transactionDate": "2024-10-25T00:00:00+05:00",
    "amount": 12.34
}
```

### GET /api/v1/Transaction/count
Получает количество транзакций в базе данных.

**Ответ:**
```json
42
```

## Валидация

- Сумма транзакции должна быть положительной
- Дата транзакции не может быть в будущем
- Ограничение на количество одновременно хранимых транзакций: 100 штук

## Управление лимитом записей

Система автоматически управляет лимитом в 100 записей:
- При достижении лимита автоматически удаляются самые старые записи
- Поддерживается работа с несколькими репликами приложения
- Используются транзакции базы данных для обеспечения атомарности операций
- Применяется блокировка на уровне базы данных для предотвращения race conditions

## Обработка ошибок

Обработка ошибок реализована в соответствии с RFC 9457 (Problem Details for HTTP APIs).

## Технологии

- .NET 8.0
- ASP.NET Core Web API
- Entity Framework Core
- PostgreSQL

## Запуск проекта

### Вариант 1: Локальный запуск

1. Убедитесь, что у вас установлен .NET 8.0 SDK
2. Клонируйте репозиторий
3. Перейдите в папку `TransactionConsumer`
4. Выполните команды:

```bash
dotnet restore
dotnet build
dotnet run
```

Приложение будет доступно по адресу: https://localhost:7001 (или http://localhost:5001)

### Вариант 2: Запуск с Docker и PostgreSQL

1. Убедитесь, что у вас установлен Docker и Docker Compose
2. Клонируйте репозиторий
3. В корневой папке проекта выполните:

```bash
docker-compose up --build
```

Приложение будет доступно по адресу: http://localhost:5000

## Swagger UI

Для тестирования API доступен Swagger UI:
- Локальный запуск: https://localhost:7001/swagger
- Docker: http://localhost:5000/swagger

## База данных

### Локальный запуск
По умолчанию используется PostgreSQL. База данных создается автоматически при первом запуске приложения.

Для изменения строки подключения отредактируйте файл `appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=transactiondb;Username=postgres;Password=postgres"
  }
}
```

### Docker
При запуске через Docker Compose автоматически создается контейнер с PostgreSQL:
- Хост: postgres (внутри Docker сети) или localhost (для внешних подключений)
- Порт: 5432
- База данных: transactiondb
- Пользователь: postgres
- Пароль: postgres

## Docker команды

```bash
# Запуск всех сервисов
docker-compose up --build

# Запуск в фоновом режиме
docker-compose up -d --build

# Остановка сервисов
docker-compose down

# Просмотр логов
docker-compose logs -f

# Остановка и удаление всех данных
docker-compose down -v
```

## Масштабирование

Система поддерживает горизонтальное масштабирование:
- Несколько реплик приложения могут работать одновременно
- База данных автоматически управляет лимитом записей
- Используются транзакции и блокировки для обеспечения консистентности данных 